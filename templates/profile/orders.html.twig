
{% extends 'base.html.twig' %}

{% block title %}Активность — личный кабинет{% endblock %}

{% block body %}
    <section class="bg-gray-50/70 py-10 sm:py-12">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
            <div class="mb-8 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm sm:p-8">
                <h1 class="text-3xl font-bold text-gray-900">Активность и заказы</h1>
                <p class="mt-2 text-sm text-gray-600">Отслеживайте профиль, безопасность и историю ваших заявок в одном месте.</p>
            </div>

            {% include 'profile/_tabs.html.twig' %}

            <div class="mt-6 grid gap-6 lg:grid-cols-3">
                <article class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Профиль</h2>
                    <div class="mt-4 space-y-2 text-sm text-gray-700">
                        <p><span class="font-semibold">Имя:</span> {{ user.firstName ?: '—' }}</p>
                        <p><span class="font-semibold">Email:</span> {{ user.email ?: '—' }}</p>
                        <p><span class="font-semibold">Телефон:</span> {{ user.phone ?: '—' }}</p>
                    </div>
                </article>

                <article class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Безопасность</h2>
                    <div class="mt-4 space-y-2 text-sm text-gray-700">
                        <p><span class="font-semibold">Подтверждение email:</span>
                            <span class="{{ user.isVerified ? 'text-green-700' : 'text-yellow-700' }}">{{ user.isVerified ? 'Подтверждён' : 'Не подтверждён' }}</span>
                        </p>
                        <p><span class="font-semibold">Роли:</span> {{ user.roles|filter(r => r != 'ROLE_USER')|map(r => r|replace({'ROLE_': ''}))|join(', ') ?: '—' }}</p>
                        <p><span class="font-semibold">Последнее обновление:</span> {{ user.updatedAt ? user.updatedAt|date('d.m.Y H:i') : '—' }}</p>
                    </div>
                </article>

                <article class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Быстрые действия</h2>
                    <div class="mt-4 flex flex-col gap-2">
                        <a href="{{ path('app_map_app') }}" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-red-300 hover:text-red-600">Перейти на карту конструкций</a>
                        <a href="{{ path('profile') }}" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-red-300 hover:text-red-600">Редактировать профиль</a>
                    </div>
                </article>
            </div>

            <div class="mt-8 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-900">История заявок</h2>

                {% if user.phone is empty %}
                    <p class="mt-2 text-sm text-gray-600">Добавьте телефон в профиле, чтобы мы могли показать связанные заявки.</p>
                {% elseif userRequests is empty %}
                    <p class="mt-2 text-sm text-gray-600">Пока что по вашему номеру телефона заявок не найдено.</p>
                {% else %}
                    <p class="mt-2 text-sm text-gray-600">Найдено заявок: {{ userRequests|length }}.</p>

                    <div class="mt-4 overflow-hidden rounded-xl border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50 text-left text-xs uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3">Дата</th>
                                <th class="px-4 py-3">Конструкция</th>
                                <th class="px-4 py-3">Сторона</th>
                                <th class="px-4 py-3">Комментарий</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white text-gray-700">
                            {% for request in userRequests %}
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ request.createdAt ? request.createdAt|date('d.m.Y H:i') : '—' }}</td>
                                    <td class="px-4 py-3">{{ request.advertisement ? (request.advertisement.code ?: request.advertisement.placeNumber ?: ('#' ~ request.advertisement.id)) : '—' }}</td>
                                    <td class="px-4 py-3">{{ request.sideCode ?: '—' }}</td>
                                    <td class="px-4 py-3">{{ request.comment ?: '—' }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
{% endblock %}
